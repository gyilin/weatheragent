name: Daily Weather Push

on:
  schedule:
    - cron: '0 12 * * *'  # æ¯å¤© 8AM ç¾Žå›½ä¸œéƒ¨æ—¶é—´ï¼ˆ12:00 UTCï¼‰
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install requests
        run: pip install requests

      - name: Run weather agent
        env:
          API_KEY: ${{ secrets.QWEATHER_KEY }}
          CITY: ${{ secrets.CITY }}
          SENDKEY: ${{ secrets.SENDKEY }}
        run: |
          echo "import requests, datetime

API_KEY = '${{ secrets.QWEATHER_KEY }}'
CITY = '${{ secrets.CITY }}'
SENDKEY = '${{ secrets.SENDKEY }}'

def get_weather():
    url = f'https://devapi.qweather.com/v7/weather/now?location={CITY}&adm=USA&key={API_KEY}'
    resp = requests.get(url)
    data = resp.json()
    if data.get('code') != '200':
        return 'âŒ å¤©æ°”èŽ·å–å¤±è´¥'
    now = data['now']
    weather_text = now['text']
    temp = now['temp']
    wind_dir = now['windDir']
    wind_scale = now['windScale']
    date = datetime.datetime.now().strftime('%Y-%m-%d (%A)')
    msg = (
        f'ðŸ“ åŸŽå¸‚ï¼šBoston ðŸ‡ºðŸ‡¸\\n'
        f'ðŸ“… æ—¥æœŸï¼š{date}\\n'
        f'ðŸŒ¦ï¸ å¤©æ°”ï¼š{weather_text}\\n'
        f'ðŸŒ¡ï¸ æ°”æ¸©ï¼š{temp}â„ƒ\\n'
        f'ðŸ’¨ é£ŽåŠ›ï¼š{wind_dir} {wind_scale}çº§\\n'
        f'ðŸ§¥ æç¤ºï¼šå‡ºé—¨è®°å¾—æŸ¥çœ‹å¤©æ°”å˜åŒ–å“¦ï¼'
    )
    return msg

def send_wechat(msg):
    push_url = f'https://sctapi.ftqq.com/{SENDKEY}.send'
    data = {'title': 'ä»Šæ—¥å¤©æ°”æé†’ â˜€ï¸', 'desp': msg}
    requests.post(push_url, data=data)

msg = get_weather()
send_wechat(msg)
" > weather_run.py
          python weather_run.py
